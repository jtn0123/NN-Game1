<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Network AI - Training Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>üß† Neural Network AI</h1>
                <span class="subtitle">Breakout Training Dashboard</span>
            </div>
            <div class="header-right">
                <div class="status-indicator" id="status-indicator">
                    <span class="status-dot"></span>
                    <span class="status-text">Connecting...</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Left Column: Charts + Console -->
            <div class="charts-column">
                <!-- Score Chart -->
                <div class="chart-card">
                    <div class="card-header">
                        <h2 data-tooltip="Shows score per episode over time. Green line = individual episode scores. Yellow dashed = 20-episode moving average. Upward trend indicates learning progress." data-tooltip-position="right">üìä Training Progress</h2>
                        <div class="chart-legend">
                            <span class="legend-item score" data-tooltip="Raw score for each episode">‚óè Score</span>
                            <span class="legend-item avg" data-tooltip="Smoothed average over last 20 episodes - better shows overall trend">‚óè Average</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="scoreChart"></canvas>
                    </div>
                </div>

                <!-- Dual Chart Row -->
                <div class="chart-row">
                    <!-- Loss Chart -->
                    <div class="chart-card half">
                        <div class="card-header">
                            <h2 data-tooltip="Measures prediction error (log scale). Spikes are normal during exploration. Generally should trend downward as the AI improves its value estimates." data-tooltip-position="right">üìâ Loss</h2>
                        </div>
                        <div class="chart-container small">
                            <canvas id="lossChart"></canvas>
                        </div>
                    </div>

                    <!-- Q-Value Chart -->
                    <div class="chart-card half">
                        <div class="card-header">
                            <h2 data-tooltip="Average expected future reward. Rising Q-values mean the AI is learning to recognize valuable game states. Stable or slowly increasing = healthy learning." data-tooltip-position="left">üìà Avg Q-Value</h2>
                        </div>
                        <div class="chart-container small">
                            <canvas id="qvalueChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Console Log -->
                <div class="console-card">
                    <div class="card-header">
                        <h2>üìã Console Log</h2>
                        <div class="console-controls">
                            <div class="filter-buttons">
                                <button class="filter-btn active" data-filter="all" onclick="setLogFilter('all')">All</button>
                                <button class="filter-btn" data-filter="info" onclick="setLogFilter('info')">Info</button>
                                <button class="filter-btn" data-filter="metric" onclick="setLogFilter('metric')">Metrics</button>
                                <button class="filter-btn" data-filter="action" onclick="setLogFilter('action')">Actions</button>
                                <button class="filter-btn" data-filter="warning" onclick="setLogFilter('warning')">Warnings</button>
                            </div>
                            <button class="copy-btn" onclick="copyLogsToClipboard()" title="Copy logs to clipboard">üìã Copy</button>
                            <button class="clear-btn" onclick="clearLogs()">üóëÔ∏è Clear</button>
                        </div>
                    </div>
                    <div class="console-container" id="console-container">
                        <div class="console-output" id="console-output">
                            <div class="console-line info">
                                <span class="log-time">--:--:--</span>
                                <span class="log-level">INFO</span>
                                <span class="log-message">Waiting for connection...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Stats & Controls -->
            <div class="stats-column">
                <!-- Metrics Grid -->
                <div class="metrics-grid">
                    <div class="metric-card" data-tooltip="One complete game from start to finish. Each episode ends when all bricks are cleared (win) or the ball is lost (lose)." data-tooltip-position="bottom">
                        <div class="metric-label">Episode</div>
                        <div class="metric-value" id="metric-episode">0</div>
                    </div>
                    <div class="metric-card highlight" data-tooltip="Points earned in the current episode. The AI gets +10 points for each brick destroyed." data-tooltip-position="bottom">
                        <div class="metric-label">Current Score</div>
                        <div class="metric-value" id="metric-score">0</div>
                    </div>
                    <div class="metric-card best" data-tooltip="The highest score achieved in any single episode. This shows the AI's peak performance so far." data-tooltip-position="bottom">
                        <div class="metric-label">Best Score</div>
                        <div class="metric-value" id="metric-best">0</div>
                    </div>
                    <div class="metric-card" data-tooltip="Percentage of recent episodes where the AI cleared all bricks. Higher = better. Calculated over a rolling window." data-tooltip-position="bottom">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value" id="metric-winrate">0%</div>
                    </div>
                </div>

                <!-- Epsilon Gauge -->
                <div class="gauge-card" data-tooltip="Epsilon (Œµ) controls random exploration. At Œµ=1.0, the AI takes 100% random actions to discover new strategies. As training progresses, Œµ decays toward 0, making the AI rely more on learned knowledge (exploitation). This balance helps avoid getting stuck in suboptimal patterns.">
                    <div class="card-header">
                        <h3>üé≤ Exploration (Œµ)</h3>
                        <span class="gauge-value" id="epsilon-value">1.000</span>
                    </div>
                    <div class="gauge-container">
                        <div class="gauge-bar">
                            <div class="gauge-fill" id="epsilon-fill"></div>
                        </div>
                        <div class="gauge-labels">
                            <span data-tooltip="Using learned knowledge to pick the best known action" data-tooltip-position="bottom">Exploit</span>
                            <span data-tooltip="Trying random actions to discover new strategies" data-tooltip-position="bottom">Explore</span>
                        </div>
                    </div>
                </div>

                <!-- Extended Training Info -->
                <div class="info-card">
                    <div class="card-header">
                        <h3>‚öôÔ∏è Training Stats</h3>
                    </div>
                    <div class="info-grid">
                        <div class="info-row" data-tooltip="How wrong the AI's predictions were. Lower = better. The neural network learns by minimizing this error between predicted and actual rewards.">
                            <span class="info-label">Loss</span>
                            <span class="info-value" id="info-loss">0.0000</span>
                        </div>
                        <div class="info-row" data-tooltip="Total individual actions taken across all episodes. Each paddle movement or 'stay' decision is one step.">
                            <span class="info-label">Total Steps</span>
                            <span class="info-value" id="info-steps">0</span>
                        </div>
                        <div class="info-row" data-tooltip="Episodes completed per second. Higher speeds = faster training. Affected by game speed multiplier.">
                            <span class="info-label">Ep/s</span>
                            <span class="info-value" id="info-eps">0.0</span>
                        </div>
                        <div class="info-row" data-tooltip="Replay buffer storing past experiences (state, action, reward, next_state). The AI samples random batches from memory to learn from, preventing forgetting old lessons.">
                            <span class="info-label">Memory</span>
                            <span class="info-value" id="info-memory">0 / 100k</span>
                        </div>
                        <div class="info-row" data-tooltip="Average predicted future reward. Higher Q-values mean the AI expects better outcomes. Should increase during successful training as the AI learns which states lead to high scores.">
                            <span class="info-label">Avg Q-Value</span>
                            <span class="info-value" id="info-qvalue">0.00</span>
                        </div>
                        <div class="info-row" data-tooltip="How many times the 'target network' was synchronized with the main network. The target network provides stable learning targets and updates periodically to prevent oscillation.">
                            <span class="info-label">Target Updates</span>
                            <span class="info-value" id="info-target">0</span>
                        </div>
                        <div class="info-row" data-tooltip="Count of random actions (explore) vs. learned actions (exploit). Early training has more exploration; later training shifts toward exploitation.">
                            <span class="info-label">Explore/Exploit</span>
                            <span class="info-value" id="info-actions">0 / 0</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Status</span>
                            <span class="info-value status-badge" id="info-status">Training</span>
                        </div>
                    </div>
                </div>

                <!-- Game Preview -->
                <div class="preview-card">
                    <div class="card-header">
                        <h3>üéÆ Game Preview</h3>
                        <button class="refresh-btn" onclick="refreshScreenshot()">‚Üª</button>
                    </div>
                    <div class="preview-container">
                        <img id="game-preview" src="" alt="Game Preview">
                        <div class="preview-placeholder" id="preview-placeholder">
                            No preview available
                        </div>
                    </div>
                </div>

                <!-- Main Controls -->
                <div class="controls-card">
                    <div class="card-header">
                        <h3>üéõÔ∏è Controls</h3>
                    </div>
                    <div class="controls-grid">
                        <button class="control-btn pause" id="pause-btn" onclick="togglePause()" data-tooltip="Pause or resume training. Keyboard: P" data-tooltip-position="bottom">
                            ‚è∏Ô∏è Pause
                        </button>
                        <button class="control-btn save" onclick="saveModel()" data-tooltip="Save current neural network weights to file. Keyboard: Ctrl+S" data-tooltip-position="bottom">
                            üíæ Save
                        </button>
                        <button class="control-btn reset" onclick="resetEpisode()" data-tooltip="End current episode and start fresh. Useful if AI gets stuck. Keyboard: R" data-tooltip-position="bottom">
                            üîÑ Reset
                        </button>
                        <button class="control-btn load" onclick="showLoadModal()" data-tooltip="Load a previously saved model to continue training or evaluate performance." data-tooltip-position="bottom">
                            üìÇ Load
                        </button>
                    </div>
                    
                    <!-- Speed Control -->
                    <div class="speed-control" data-tooltip="Game simulation speed. Higher = faster training. Use 50x-100x for rapid training on fast hardware, 0.5x-1x to watch AI behavior clearly." data-tooltip-position="left">
                        <label class="speed-label">
                            <span>‚è© Speed</span>
                            <span id="speed-value">1.0x</span>
                        </label>
                        <input type="range" 
                               id="speed-slider" 
                               min="0.25" 
                               max="200" 
                               step="0.5" 
                               value="1"
                               oninput="updateSpeed(this.value)">
                        <div class="speed-marks">
                            <span>0.25x</span>
                            <span>50x</span>
                            <span>100x</span>
                            <span>200x</span>
                        </div>
                    </div>
                </div>

                <!-- Settings Panel -->
                <div class="settings-card collapsed" id="settings-card">
                    <div class="card-header clickable" onclick="toggleSettings()">
                        <h3>‚öôÔ∏è Settings</h3>
                        <span class="collapse-icon" id="settings-icon">‚ñº</span>
                    </div>
                    <div class="settings-content" id="settings-content">
                        <div class="setting-row" data-tooltip="How fast the network learns. Too high = unstable, overshooting. Too low = very slow learning. Default 0.0001 is a safe starting point.">
                            <label for="setting-lr">Learning Rate</label>
                            <input type="number" id="setting-lr" value="0.0001" step="0.00001" min="0">
                        </div>
                        <div class="setting-row" data-tooltip="Current exploration rate. Set to 1.0 to restart exploration, or lower to make AI rely more on learned behavior.">
                            <label for="setting-epsilon">Epsilon</label>
                            <input type="number" id="setting-epsilon" value="1.0" step="0.01" min="0" max="1">
                        </div>
                        <div class="setting-row" data-tooltip="Multiplier applied to epsilon after each episode. 0.995 means epsilon reduces by 0.5% each episode. Lower = faster decay to exploitation.">
                            <label for="setting-decay">Epsilon Decay</label>
                            <input type="number" id="setting-decay" value="0.995" step="0.001" min="0" max="1">
                        </div>
                        <div class="setting-row" data-tooltip="Discount factor for future rewards. 0.99 means future rewards are 99% as valuable as immediate rewards. Higher = more long-term planning.">
                            <label for="setting-gamma">Gamma</label>
                            <input type="number" id="setting-gamma" value="0.99" step="0.01" min="0" max="1">
                        </div>
                        <div class="setting-row" data-tooltip="Number of experiences sampled from memory per training step. Larger batches = more stable but slower learning.">
                            <label for="setting-batch">Batch Size</label>
                            <input type="number" id="setting-batch" value="64" step="8" min="8">
                        </div>
                        <button class="apply-btn" onclick="applySettings()">Apply Changes</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <span data-tooltip="A neural network learns to play Breakout by trial and error, improving its strategy over thousands of games.">Neural Network Game AI</span>
            <span class="separator">|</span>
            <span data-tooltip="Double DQN: Uses two networks to prevent overestimating action values. Prioritized Replay: Learns more from important experiences (surprising outcomes). These techniques make learning faster and more stable.">Double DQN + Prioritized Replay</span>
            <span class="separator">|</span>
            <span id="footer-time"></span>
        </footer>
    </div>

    <!-- Load Model Modal -->
    <div class="modal" id="load-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÇ Load Model</h3>
                <button class="close-btn" onclick="hideLoadModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="model-list" id="model-list">
                    <div class="loading">Loading models...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>

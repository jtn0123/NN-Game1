<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Network AI - Training Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>üß† Neural Network AI</h1>
                <div class="game-selector" data-tooltip="Select which game to train" data-tooltip-position="bottom">
                    <select id="game-select" onchange="switchGame(this.value)">
                        <option value="breakout">üß± Breakout</option>
                    </select>
                    <span class="subtitle" id="game-subtitle">Training Dashboard</span>
                </div>
            </div>
            <div class="header-right">
                <div class="system-status">
                    <span class="system-badge device" id="device-badge" data-tooltip="Compute device being used for neural network operations" data-tooltip-position="bottom">üñ•Ô∏è CPU</span>
                    <span class="system-badge compile" id="compile-badge" data-tooltip="torch.compile() status - when enabled, provides ~20-50% speedup" data-tooltip-position="bottom">üì¶ Eager</span>
                </div>
                <div class="status-indicator" id="status-indicator">
                    <span class="status-dot"></span>
                    <span class="status-text">Connecting...</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Left Column: Charts + Console -->
            <div class="charts-column">
                <!-- Score Chart -->
                <div class="chart-card">
                    <div class="card-header">
                        <h2 data-tooltip="Shows score per episode over time. Green line = individual episode scores. Yellow dashed = 20-episode moving average. Upward trend indicates learning progress." data-tooltip-position="right">üìä Training Progress</h2>
                        <div class="chart-legend">
                            <span class="legend-item score" data-tooltip="Raw score for each episode">‚óè Score</span>
                            <span class="legend-item avg" data-tooltip="Smoothed average over last 20 episodes - better shows overall trend">‚óè Average</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="scoreChart"></canvas>
                    </div>
                </div>

                <!-- Dual Chart Row -->
                <div class="chart-row">
                    <!-- Loss Chart -->
                    <div class="chart-card half">
                        <div class="card-header">
                            <h2 data-tooltip="Measures prediction error (log scale). Spikes are normal during exploration. Generally should trend downward as the AI improves its value estimates." data-tooltip-position="right">üìâ Loss</h2>
                        </div>
                        <div class="chart-container small">
                            <canvas id="lossChart"></canvas>
                        </div>
                    </div>

                    <!-- Q-Value Chart -->
                    <div class="chart-card half">
                        <div class="card-header">
                            <h2 data-tooltip="Average expected future reward. Rising Q-values mean the AI is learning to recognize valuable game states. Stable or slowly increasing = healthy learning." data-tooltip-position="left">üìà Avg Q-Value</h2>
                        </div>
                        <div class="chart-container small">
                            <canvas id="qvalueChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Neural Network Visualization -->
                <div class="nn-viz-card" id="nn-viz-card" data-tooltip="Real-time visualization of the neural network's internal state. Shows how neurons activate and how information flows through the network as it makes decisions." data-tooltip-position="right">
                    <div class="card-header clickable" onclick="toggleNNPanel()">
                        <div class="nn-viz-header-left">
                            <h3>üß† Neural Network</h3>
                            <span class="nn-viz-status" id="nn-viz-status">‚óè LIVE</span>
                        </div>
                        <div class="nn-viz-header-right">
                            <button class="nn-viz-toggle" onclick="event.stopPropagation(); toggleNNVisualization()">‚è∏Ô∏è</button>
                            <span class="collapse-icon" id="nn-viz-icon">‚ñ≤</span>
                        </div>
                    </div>
                    <div class="nn-viz-content" id="nn-viz-content">
                        <div class="nn-canvas-container">
                            <canvas id="nn-canvas"></canvas>
                            <div class="nn-viz-placeholder" id="nn-viz-placeholder">
                                <div class="placeholder-icon">üß†</div>
                                <div class="placeholder-text">Waiting for network data...</div>
                                <div class="placeholder-hint">Data will appear when training starts</div>
                            </div>
                        </div>
                        <div class="nn-viz-legend">
                            <div class="nn-legend-item">
                                <span class="nn-legend-dot positive"></span>
                                <span>Positive</span>
                            </div>
                            <div class="nn-legend-item">
                                <span class="nn-legend-dot neutral"></span>
                                <span>Neutral</span>
                            </div>
                            <div class="nn-legend-item">
                                <span class="nn-legend-dot negative"></span>
                                <span>Negative</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Console Log -->
                <div class="console-card">
                    <div class="card-header">
                        <h2>üìã Console Log</h2>
                        <div class="console-controls">
                            <div class="filter-buttons">
                                <button class="filter-btn active" data-filter="all" onclick="setLogFilter('all')">All</button>
                                <button class="filter-btn" data-filter="info" onclick="setLogFilter('info')">Info</button>
                                <button class="filter-btn" data-filter="metric" onclick="setLogFilter('metric')">Metrics</button>
                                <button class="filter-btn" data-filter="action" onclick="setLogFilter('action')">Actions</button>
                                <button class="filter-btn" data-filter="warning" onclick="setLogFilter('warning')">Warnings</button>
                            </div>
                            <button class="copy-btn" onclick="copyLogsToClipboard()" title="Copy logs to clipboard">üìã Copy</button>
                            <button class="clear-btn" onclick="clearLogs()">üóëÔ∏è Clear</button>
                        </div>
                    </div>
                    <div class="console-container" id="console-container">
                        <div class="console-output" id="console-output">
                            <div class="console-line info">
                                <span class="log-time">--:--:--</span>
                                <span class="log-level">INFO</span>
                                <span class="log-message">Waiting for connection...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Stats & Controls -->
            <div class="stats-column">
                <!-- Metrics Grid -->
                <div class="metrics-grid">
                    <div class="metric-card" data-tooltip="One complete game from start to finish. Each episode ends when all bricks are cleared (win) or the ball is lost (lose)." data-tooltip-position="bottom">
                        <div class="metric-label">Episode</div>
                        <div class="metric-value" id="metric-episode">0</div>
                    </div>
                    <div class="metric-card highlight" data-tooltip="Points earned in the current episode. The AI gets +10 points for each brick destroyed." data-tooltip-position="bottom">
                        <div class="metric-label">Current Score</div>
                        <div class="metric-value" id="metric-score">0</div>
                    </div>
                    <div class="metric-card best" data-tooltip="The highest score achieved in any single episode. This shows the AI's peak performance so far." data-tooltip-position="bottom">
                        <div class="metric-label">Best Score</div>
                        <div class="metric-value" id="metric-best">0</div>
                    </div>
                    <div class="metric-card" data-tooltip="Percentage of recent episodes where the AI cleared all bricks. Higher = better. Calculated over a rolling window." data-tooltip-position="bottom">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value" id="metric-winrate">0%</div>
                    </div>
                </div>

                <!-- Epsilon Gauge -->
                <div class="gauge-card" data-tooltip="Epsilon (Œµ) controls random exploration. At Œµ=1.0, the AI takes 100% random actions to discover new strategies. As training progresses, Œµ decays toward 0, making the AI rely more on learned knowledge (exploitation). This balance helps avoid getting stuck in suboptimal patterns.">
                    <div class="card-header">
                        <h3>üé≤ Exploration (Œµ)</h3>
                        <span class="gauge-value" id="epsilon-value">1.000</span>
                    </div>
                    <div class="gauge-container">
                        <div class="gauge-bar">
                            <div class="gauge-fill" id="epsilon-fill"></div>
                        </div>
                        <div class="gauge-labels">
                            <span data-tooltip="Using learned knowledge to pick the best known action" data-tooltip-position="bottom">Exploit</span>
                            <span data-tooltip="Trying random actions to discover new strategies" data-tooltip-position="bottom">Explore</span>
                        </div>
                    </div>
                </div>

                <!-- Extended Training Info -->
                <div class="info-card">
                    <div class="card-header">
                        <h3>üìä Training Stats</h3>
                        <span class="info-value status-badge training" id="info-status">Training</span>
                    </div>
                    <div class="info-grid">
                        <!-- Performance Section -->
                        <div class="info-section">
                            <div class="info-row highlight-metric" data-tooltip="Training steps per second - the key performance metric. Higher = faster learning. Affected by learn_every setting and batch size.">
                                <span class="info-label">‚ö° Steps/s</span>
                                <span class="info-value" id="info-steps-sec">0</span>
                            </div>
                            <div class="info-row" data-tooltip="Episodes completed per second. Higher speeds = faster training.">
                                <span class="info-label">üìà Ep/s</span>
                                <span class="info-value" id="info-eps">0.0</span>
                            </div>
                            <div class="info-row" data-tooltip="Estimated time remaining. Shows '‚àû Unlimited' when training indefinitely (use --episodes to set a target).">
                                <span class="info-label">‚è±Ô∏è ETA</span>
                                <span class="info-value" id="info-eta">‚àû Unlimited</span>
                            </div>
                        </div>
                        
                        <!-- Learning Metrics -->
                        <div class="info-section">
                            <div class="info-row" data-tooltip="How wrong the AI's predictions were. Lower = better. The neural network learns by minimizing this error between predicted and actual rewards.">
                                <span class="info-label">Loss</span>
                                <span class="info-value" id="info-loss">0.0000</span>
                            </div>
                            <div class="info-row" data-tooltip="Average predicted future reward. Higher Q-values mean the AI expects better outcomes. Should increase during successful training as the AI learns which states lead to high scores.">
                                <span class="info-label">Avg Q-Value</span>
                                <span class="info-value" id="info-qvalue">0.00</span>
                            </div>
                            <div class="info-row" data-tooltip="Total individual actions taken across all episodes. Each paddle movement or 'stay' decision is one step.">
                                <span class="info-label">Total Steps</span>
                                <span class="info-value" id="info-steps">0</span>
                            </div>
                        </div>
                        
                        <!-- Network State -->
                        <div class="info-section">
                            <div class="info-row" data-tooltip="How many times the 'target network' was synchronized with the main network. The target network provides stable learning targets and updates periodically to prevent oscillation.">
                                <span class="info-label">Target Updates</span>
                                <span class="info-value" id="info-target">0</span>
                            </div>
                            <div class="info-row" data-tooltip="Count of random actions (explore) vs. learned actions (exploit). Early training has more exploration; later training shifts toward exploitation.">
                                <span class="info-label">Explore / Exploit</span>
                                <span class="info-value" id="info-actions">0 / 0</span>
                            </div>
                            <div class="info-row" data-tooltip="Number of parallel game environments running. More environments = faster training throughput.">
                                <span class="info-label">üéÆ Parallel Envs</span>
                                <span class="info-value" id="info-vec-envs">1</span>
                            </div>
                        </div>

                        <!-- Memory -->
                        <div class="info-section memory-section">
                            <div class="info-row memory-row" data-tooltip="Replay buffer storing past experiences (state, action, reward, next_state). The AI samples random batches from memory to learn from, preventing forgetting old lessons.">
                                <span class="info-label">üß† Replay Memory</span>
                                <div class="memory-display">
                                    <span class="info-value" id="info-memory">0 / 100k</span>
                                    <div class="memory-bar">
                                        <div class="memory-bar-fill" id="memory-bar-fill"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Game Preview -->
                <div class="preview-card">
                    <div class="card-header">
                        <h3>üéÆ Game Preview</h3>
                        <button class="refresh-btn" onclick="refreshScreenshot()">‚Üª</button>
                    </div>
                    <div class="preview-container">
                        <img id="game-preview" src="" alt="Game Preview">
                        <div class="preview-placeholder" id="preview-placeholder">
                            No preview available
                        </div>
                    </div>
                </div>

                <!-- Main Controls -->
                <div class="controls-card">
                    <div class="card-header">
                        <h3>üéõÔ∏è Controls</h3>
                    </div>
                    
                    <!-- Performance Mode Presets -->
                    <div class="performance-modes" data-tooltip="Performance presets control how often the AI learns. Faster modes skip some learning steps for higher throughput.">
                        <label class="mode-label">‚ö° Performance Mode</label>
                        <div class="mode-buttons">
                            <button class="mode-btn active" id="mode-normal" onclick="setPerformanceMode('normal')" data-tooltip="Learn every step. Best for watching learning in detail. ~200-300 steps/sec">
                                Normal
                            </button>
                            <button class="mode-btn" id="mode-fast" onclick="setPerformanceMode('fast')" data-tooltip="Learn every 4 steps. ~4x faster training with minimal learning impact. ~800-1200 steps/sec">
                                Fast
                            </button>
                            <button class="mode-btn turbo" id="mode-turbo" onclick="setPerformanceMode('turbo')" data-tooltip="Learn every 8 steps + 2 gradient updates. Maximum training speed. ~5000 steps/sec on M4">
                                üöÄ Turbo
                            </button>
                            <button class="mode-btn ultra" id="mode-ultra" onclick="setPerformanceMode('ultra')" data-tooltip="Learn every 16 steps + 4 gradient updates + batch 256. Extreme throughput. ~8000+ steps/sec">
                                ‚ö° Ultra
                            </button>
                        </div>
                    </div>
                    
                    <div class="controls-grid">
                        <button class="control-btn pause" id="pause-btn" onclick="togglePause()" data-tooltip="Pause or resume training. Keyboard: P" data-tooltip-position="bottom">
                            ‚è∏Ô∏è Pause
                        </button>
                        <button class="control-btn save" onclick="saveModel()" data-tooltip="Save current neural network weights to file. Keyboard: Ctrl+S" data-tooltip-position="bottom">
                            üíæ Save
                        </button>
                        <button class="control-btn reset" onclick="resetEpisode()" data-tooltip="Reset current episode only - ends the current game and starts a new one. Does not reset training progress. Keyboard: Ctrl+R" data-tooltip-position="bottom">
                            üîÑ Reset Episode
                        </button>
                        <button class="control-btn load" onclick="showLoadModal()" data-tooltip="Load a previously saved model to continue training or evaluate performance." data-tooltip-position="bottom">
                            üìÇ Load
                        </button>
                        <button class="control-btn fresh" onclick="startFresh()" data-tooltip="Start completely fresh - resets the neural network, clears all training memory, and resets all progress. Saved models on disk are preserved. Keyboard: Ctrl+Shift+R" data-tooltip-position="bottom">
                            üÜï Start Fresh
                        </button>
                        <button class="control-btn quit" onclick="saveAndQuit()" data-tooltip="Save current progress and exit the training application. Keyboard: Ctrl+Q" data-tooltip-position="bottom">
                            üö™ Save & Quit
                        </button>
                    </div>
                    
                    <!-- Speed Control -->
                    <div class="speed-control" data-tooltip="Training speed multiplier. Higher = more training steps per frame. Auto-targets your display's refresh rate." data-tooltip-position="left">
                        <label class="speed-label">
                            <span>‚è© Speed</span>
                            <span id="speed-value">1x</span>
                        </label>
                        <input type="range" 
                               id="speed-slider" 
                               min="1" 
                               max="1000" 
                               step="1" 
                               value="1"
                               oninput="updateSpeed(this.value)">
                        <div class="speed-marks">
                            <span>1x</span>
                            <span>100x</span>
                            <span>500x</span>
                            <span>1000x</span>
                        </div>
                    </div>
                </div>

                <!-- Save Management Panel -->
                <div class="save-card" id="save-card">
                    <div class="card-header">
                        <h3>üíæ Model Saves</h3>
                        <span class="save-indicator" id="save-indicator"></span>
                    </div>
                    <div class="save-status" id="save-status">
                        <div class="save-status-row">
                            <span class="save-label">Last Save:</span>
                            <span class="save-value" id="last-save-time">Never</span>
                        </div>
                        <div class="save-status-row">
                            <span class="save-label">File:</span>
                            <span class="save-value" id="last-save-file">-</span>
                        </div>
                        <div class="save-status-row">
                            <span class="save-label">Reason:</span>
                            <span class="save-value save-reason" id="last-save-reason">-</span>
                        </div>
                        <div class="save-status-row">
                            <span class="save-label">Saves:</span>
                            <span class="save-value" id="saves-count">0</span>
                        </div>
                    </div>
                    <div class="save-actions">
                        <div class="save-as-row">
                            <input type="text" id="save-as-name" placeholder="custom_name" maxlength="30">
                            <button class="save-as-btn" onclick="saveModelAs()" title="Save with custom name">Save As</button>
                        </div>
                        <button class="browse-models-btn" onclick="showLoadModal()">üìÇ Browse All Models</button>
                    </div>
                </div>

                <!-- Settings Panel -->
                <div class="settings-card collapsed" id="settings-card">
                    <div class="card-header clickable" onclick="toggleSettings()">
                        <h3>‚öôÔ∏è Settings</h3>
                        <span class="collapse-icon" id="settings-icon">‚ñº</span>
                    </div>
                    <div class="settings-content" id="settings-content">
                        <div class="settings-divider first">
                            <span>üß† Learning</span>
                        </div>
                        
                        <div class="settings-group">
                            <div class="setting-row" data-tooltip="How fast the network learns. Too high = unstable, overshooting. Too low = very slow learning. Default 0.0001 is a safe starting point.">
                                <label for="setting-lr">Learning Rate</label>
                                <input type="number" id="setting-lr" value="0.0001" step="0.00001" min="0">
                            </div>
                            <div class="setting-row" data-tooltip="Discount factor for future rewards. 0.99 means future rewards are 99% as valuable as immediate rewards. Higher = more long-term planning.">
                                <label for="setting-gamma">Gamma (Œ≥)</label>
                                <input type="number" id="setting-gamma" value="0.99" step="0.01" min="0" max="1">
                            </div>
                            <div class="setting-row" data-tooltip="Number of experiences sampled from memory per training step. Larger batches = more stable but slower learning. M4 Mac benefits from 128-256.">
                                <label for="setting-batch">Batch Size</label>
                                <input type="number" id="setting-batch" value="128" step="32" min="32">
                            </div>
                        </div>
                        
                        <div class="settings-divider">
                            <span>üé≤ Exploration</span>
                        </div>
                        
                        <div class="settings-group">
                            <div class="setting-row" data-tooltip="Current exploration rate. Set to 1.0 to restart exploration, or lower to make AI rely more on learned behavior.">
                                <label for="setting-epsilon">Epsilon (Œµ)</label>
                                <input type="number" id="setting-epsilon" value="1.0" step="0.01" min="0" max="1">
                            </div>
                            <div class="setting-row" data-tooltip="Multiplier applied to epsilon after each episode. 0.995 means epsilon reduces by 0.5% each episode. Lower = faster decay to exploitation.">
                                <label for="setting-decay">Decay Rate</label>
                                <input type="number" id="setting-decay" value="0.995" step="0.001" min="0" max="1">
                            </div>
                        </div>
                        
                        <div class="settings-divider">
                            <span>‚ö° Performance</span>
                        </div>
                        
                        <div class="settings-group">
                            <div class="setting-row" data-tooltip="Learn every N steps. 1=every step (detailed), 4=every 4th step (~4x faster). Higher values increase throughput but may slow convergence.">
                                <label for="setting-learn-every">Learn Every</label>
                                <div class="range-input">
                                    <input type="range" id="setting-learn-every" value="1" min="1" max="16" step="1" oninput="updateLearnEveryLabel(this.value)">
                                    <span id="learn-every-value">1 step</span>
                                </div>
                            </div>
                            <div class="setting-row" data-tooltip="Number of gradient updates per learning call. Useful to compensate when learn_every > 1.">
                                <label for="setting-grad-steps">Gradient Steps</label>
                                <input type="number" id="setting-grad-steps" value="1" step="1" min="1" max="8">
                            </div>
                            <div class="setting-row vec-envs-row" data-tooltip="Number of parallel game environments. Higher = faster training but requires more memory. Requires restart to apply changes.">
                                <label for="setting-vec-envs">Parallel Envs</label>
                                <div class="vec-envs-control">
                                    <input type="number" id="setting-vec-envs" value="1" min="1" max="32" step="1">
                                    <span class="restart-badge" id="vec-envs-restart-badge">Restart required</span>
                                </div>
                            </div>
                        </div>

                        <button class="apply-btn" onclick="applySettings()">Apply Changes</button>
                    </div>
                </div>

                <!-- Game Comparison Panel -->
                <div class="comparison-card collapsed" id="comparison-card">
                    <div class="card-header clickable" onclick="toggleComparison()">
                        <h3>üìä Game Comparison</h3>
                        <span class="collapse-icon" id="comparison-icon">‚ñº</span>
                    </div>
                    <div class="comparison-content" id="comparison-content">
                        <div class="comparison-grid" id="comparison-grid">
                            <div class="loading">Loading game stats...</div>
                        </div>
                        <button class="refresh-btn" onclick="refreshGameStats()">‚Üª Refresh</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <span data-tooltip="A neural network learns to play Breakout by trial and error, improving its strategy over thousands of games.">Neural Network Game AI</span>
            <span class="separator">|</span>
            <span data-tooltip="Double DQN: Uses two networks to prevent overestimating action values. Prioritized Replay: Learns more from important experiences (surprising outcomes). These techniques make learning faster and more stable.">Double DQN + Prioritized Replay</span>
            <span class="separator">|</span>
            <span id="footer-time"></span>
        </footer>
    </div>

    <!-- Load Model Modal -->
    <div class="modal" id="load-modal">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h3>üìÇ Model Browser</h3>
                <button class="close-btn" onclick="hideLoadModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="model-list" id="model-list">
                    <div class="loading">Loading models...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>
